import { GoogleSpreadsheet } from 'google-spreadsheet';
import config from '../config';

// tslint:disable-next-line:no-var-requires
const moment = require('moment');

export const projectExportSpreadsheet = async (): Promise<
  typeof GoogleSpreadsheet
> => {
  // Initialize the sheet - document ID is the long id in the sheets URL
  const spreadSheet = new GoogleSpreadsheet(
    config.get('GOOGLE_PROJECT_EXPORTS_SPREADSHEET_ID'),
  );

  // Initialize Auth - see https://theoephraim.github.io/node-google-spreadsheet/#/getting-started/authentication
  await spreadSheet.useServiceAccountAuth({
    // env var values are copied from service account credentials generated by google
    // see "Authentication" section in docs for more info
    client_email: config.get('GOOGLE_SPREADSHEETS_CLIENT_EMAIL'),
    private_key: config.get('GOOGLE_SPREADSHEETS_PRIVATE_KEY'),
  });

  return spreadSheet;
};

export const addSheetWithRows = async (
  spreadSheet,
  headers,
  rows,
): Promise<void> => {
  const currentDate = moment().toDate();

  const sheet = await spreadSheet.addSheet({
    headerValues: headers,
    title: `export ${currentDate.toDateString()} ${currentDate.getTime()}`,
  });

  // Array of objects with entity data, example:
  // [
  //   { title: 'test', ... },
  //   { title: 'awesome project', ... },
  // ]
  const appendRows = await sheet.addRows(rows);
};
